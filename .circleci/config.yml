version: 2.1

jobs:              
   test-frontend:
      docker: 
         - image: python:3.7.3-stretch
      steps:
         - checkout # checkout source code from git
         - run:
             name: Install dependencies
             command: |
               cd HelloWorld
               make install
         - run:
             name: check lint
             command: |
               cd HelloWorld
               make lint

   docker-build:
      docker:
         - image: cimg/go:1.17
      working_directory: ~/repo
      steps:
         - checkout
         - setup_remote_docker:
            version: 20.10.14
            docker_layer_caching: true
         - run:
            name: build and tag docker hub
            command: |
               cd HelloWorld
               # login
               docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}
               # build image
               docker build -t helloworld:${CIRCLE_WORKFLOW_ID:0:7} .
               # list image
               docker images
               # push to DockerHub
               docker tag helloworld:${CIRCLE_WORKFLOW_ID:0:7} ${DOCKERHUB_USERNAME}/helloworld:${CIRCLE_WORKFLOW_ID:0:7}
               docker push ${DOCKERHUB_USERNAME}/helloworld:${CIRCLE_WORKFLOW_ID:0:7}

   deploy-infrastructure:
      docker:
         - image: amazon/aws-cli
      working_directory: ~/repo
      steps:
         - checkout # checkout source code from git
         - run:
            name: Ensure front-end infrastructure exist
            command: |
               aws cloudformation deploy \
               --template-file .circleci/cloudFormations/frontend.yml \
               --stack-name "helloworld-frontend-${CIRCLE_WORKFLOW_ID:0:7}" \
               --parameter-overrides WorkflowID="${CIRCLE_WORKFLOW_ID:0:7}" \
               --tags project=helloworld \

   deploy-frontend:
      docker:
         - image: amazon/aws-cli
      steps:
         - checkout # checkout source code from git
         - run:
            name: Deploy frontend objects
            command: |
               aws s3 cp ./HelloWorld s3://helloworld-${CIRCLE_WORKFLOW_ID:0:7} --exclude "*" --include "index.html" --recursive

   smoke-test:
      docker:
         - image: python:3.7-alpine3.11
      steps:
         - checkout # checkout source code from git
         - run:
            name: Install dependencies
            command: |
              apk --no-cache add curl
         - run:
            name: Frontend smoke test.
            command: |
              URL="http://helloworld-${CIRCLE_WORKFLOW_ID:0:7}.s3-website-ap-southeast-1.amazonaws.com/"            
              if curl -s ${URL} | grep "Hello World"
              then
                return 0
              else
                return 1
              fi

   cloudfront-update:
      docker:
         - image: amazon/aws-cli
      steps:
         - checkout # checkout source code from git
         - run:
            name: Update cloudfront distribution
            command: |
              aws cloudformation deploy \
              --template-file .circleci/cloudFormations/cloudfront.yml \
              --stack-name "helloworld-cloudfront-${CIRCLE_WORKFLOW_ID:0:7}" \
              --parameter-overrides WorkflowID="${CIRCLE_WORKFLOW_ID:0:7}" \
              --tags project=helloworld            
            
workflows:
  default:
    jobs:
      - test-frontend
      - docker-build:
          requires: [test-frontend]
          filters:
            branches:
              only: [main]
      - deploy-infrastructure:
          requires: [docker-build]
      - deploy-frontend:
          requires: [deploy-infrastructure]    
      - smoke-test:
          requires: [deploy-frontend]
      - cloudfront-update:
          requires: [smoke-test]